<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vretta Assessment Platform - Secure Testing Environment</title>
    
    <!-- CKEditor 5 CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .header .description {
            color: #95a5a6;
            font-size: 1em;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .extension-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-dot.active {
            background: #27ae60;
        }

        .security-controls {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .assessment-area {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .instructions {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 4px solid #667eea;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .instructions h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-area {
            min-height: 150px;
            resize: vertical;
        }

        .ck-editor__editable {
            min-height: 250px !important;
        }

        .security-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 14px;
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .security-inactive {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .security-active {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        /* Business-ready responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .security-controls {
                justify-content: center;
            }
            
            .btn {
                padding: 15px 30px;
            }
        }

        /* Prevent Chrome Help Me Write */
        input[type="text"],
        input[type="email"],
        textarea,
        .ck-editor__editable {
            -webkit-writing-suggestions: none !important;
            writing-suggestions: none !important;
        }

        /* Additional security styling */
        ::selection {
            background: rgba(102, 126, 234, 0.2);
        }

        .secured {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
    <div class="header">
            <h1>üõ°Ô∏è Vretta Assessment Platform</h1>
            <p class="subtitle">Professional Secure Testing Environment</p>
            <p class="description">Enterprise-grade assessment security with comprehensive content protection</p>
        </div>

        <div class="status-bar">
            <div class="extension-status">
                <div id="statusDot" class="status-dot"></div>
                <span id="extensionMessage">Checking security extension...</span>
        </div>
            <div class="security-controls">
                <button id="activateBtn" class="btn btn-primary" onclick="activateSecurityMode()" disabled>
                    üîí Activate Secure Mode
        </button>
                <button id="deactivateBtn" class="btn btn-secondary" onclick="deactivateSecurityMode()" disabled>
                    üîì End Secure Session
        </button>
    </div>
        </div>

        <div class="assessment-area">
            <h2 class="section-title">üìù Assessment Workspace</h2>
            
            <div class="instructions">
                <h4>üîê Secure Assessment Instructions</h4>
                <p><strong>This is a monitored assessment environment.</strong> Once secure mode is activated:</p>
                <ul>
                    <li>Content copying, cutting, and pasting will be completely disabled</li>
                    <li>Right-click context menus will be blocked throughout the session</li>
                    <li>Text selection will be restricted to input fields only</li>
                    <li>New tabs and windows will be automatically prevented</li>
                    <li>Browser extensions will be temporarily managed for security</li>
                    <li>Chrome's "Help me write" feature will be disabled</li>
                    <li><strong>Switching to other applications will trigger security warnings</strong></li>
                    <li><strong>Focus violations will be logged and may result in assessment termination</strong></li>
                    <li>All activity will be logged for academic integrity purposes</li>
                </ul>
                <div style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <strong>‚ö†Ô∏è Important:</strong> Do not attempt to leave this browser window or switch applications during the assessment. These actions will be detected and logged as security violations.
                </div>
        </div>

        <div class="form-group">
                <label class="form-label" for="studentName">üë§ Student Name (Optional)</label>
                <input type="text" id="studentName" class="form-control" 
                       placeholder="Enter your full name (optional)"
                       autocomplete="off"
                       spellcheck="false">
            </div>

            <div class="form-group">
                <label class="form-label" for="studentId">üéì Student ID (Optional)</label>
                <input type="text" id="studentId" class="form-control" 
                       placeholder="Enter your student ID (optional)"
                       autocomplete="off"
                       spellcheck="false">
            </div>

            <div class="form-group">
                <label class="form-label" for="configSelection">‚öôÔ∏è Assessment Configuration</label>
                <select id="configSelection" class="form-control">
                    <option value="config-standard.json">Standard Configuration (Default)</option>
                    <option value="config-strict.json">Strict Mode (Enhanced Security)</option>
                    <option value="config-ai-allowed.json">AI-Assisted (Accessibility)</option>
                </select>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                    Select the security configuration appropriate for your assessment type
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="assessmentResponse">üìù Assessment Response</label>
                <textarea id="assessmentResponse" class="form-control text-area" 
                          placeholder="Type your assessment response here. This area will be monitored during secure mode."
                          autocomplete="off"
                          spellcheck="true"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="richTextEditor">‚úèÔ∏è Rich Text Editor</label>
                <div id="richTextEditor"></div>
            </div>
        </div>
    </div>

    <div id="securityIndicator" class="security-indicator security-inactive">
        üîì Standard Mode
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let securityActive = false;
        let vrettaExtensionDetected = false;
        let richTextEditor = null;

        // Business-ready CKEditor configuration
        function initializeCKEditor() {
        ClassicEditor
                .create(document.querySelector('#richTextEditor'), {
                toolbar: [
                    'heading', '|',
                        'bold', 'italic', 'underline', '|',
                    'bulletedList', 'numberedList', '|',
                    'outdent', 'indent', '|',
                    'blockQuote', 'insertTable', '|',
                    'undo', 'redo'
                    ],
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    },
                    placeholder: 'Type your detailed assessment response here. Rich formatting is available for professional presentation.',
                    // Disable Chrome Help Me Write
                    extraPlugins: [],
                    removePlugins: ['SmartSuggestions', 'WritingAssistance']
                })
                .then(editor => {
                    richTextEditor = editor;
                    
                    // Disable writing suggestions on the editor
                    const editable = editor.editing.view.document.getRoot();
                    editor.editing.view.change(writer => {
                        writer.setAttribute('writing-suggestions', 'false', editable);
                        writer.setAttribute('data-writing-suggestions', 'false', editable);
                    });
                    
                    console.log('Professional CKEditor initialized successfully');
                })
                .catch(error => {
                    console.error('Error initializing CKEditor:', error);
                    showNotification('Rich text editor failed to load', 'error');
                });
        }

        // Disable Chrome Help Me Write feature
        function disableChromeHelpMeWrite() {
            // Apply to all existing inputs
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
            inputs.forEach(input => {
                input.setAttribute('writing-suggestions', 'false');
                input.setAttribute('data-writing-suggestions', 'false');
                input.style.writingSuggestions = 'none';
            });

            // Disable for future elements
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) { // Element node
                            const newInputs = node.querySelectorAll('input[type="text"], input[type="email"], textarea');
                            newInputs.forEach(input => {
                                input.setAttribute('writing-suggestions', 'false');
                                input.setAttribute('data-writing-suggestions', 'false');
                                input.style.writingSuggestions = 'none';
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            detectExtension();
            initializeCKEditor();
            disableChromeHelpMeWrite();
            
            // Set up professional form validation
            setupFormValidation();
        });

        // Professional form validation
        function setupFormValidation() {
            const studentName = document.getElementById('studentName');
            const studentId = document.getElementById('studentId');

            studentName.addEventListener('blur', function() {
                if (this.value.trim().length < 2) {
                    this.style.borderColor = '#e74c3c';
                } else {
                    this.style.borderColor = '#27ae60';
                }
            });

            studentId.addEventListener('blur', function() {
                if (this.value.trim().length < 3) {
                    this.style.borderColor = '#e74c3c';
            } else {
                    this.style.borderColor = '#27ae60';
                }
            });
        }

        // Simplified extension detection
        function detectExtension() {
            // Check for extension bridge
            if (window.vrettaSoftLockExtension && window.vrettaSoftLockExtension.isAvailable) {
                handleExtensionDetected();
                return;
            }

            // Ping extension
            window.postMessage({ type: 'VRETTA_PING_REQUEST' }, '*');
            
            setTimeout(() => {
                if (!vrettaExtensionDetected) {
                    handleExtensionNotDetected();
                }
            }, 2000);
        }

        function handleExtensionDetected() {
            vrettaExtensionDetected = true;
            const statusDot = document.getElementById('statusDot');
            const messageSpan = document.getElementById('extensionMessage');
            
            statusDot.classList.add('active');
            messageSpan.textContent = '‚úÖ Vretta Security Extension Ready';
            
            document.getElementById('activateBtn').disabled = false;
            showNotification('Security extension detected and ready for use', 'success');
        }

        function handleExtensionNotDetected() {
            const messageSpan = document.getElementById('extensionMessage');
            messageSpan.innerHTML = '‚ùå Security extension required - <a href="#" onclick="location.reload()">Refresh Page</a>';
            
            document.getElementById('activateBtn').disabled = true;
            showNotification('Please install the Vretta Security Extension to continue', 'error');
        }

        // Professional security mode activation
        async function activateSecurityMode() {
            if (!vrettaExtensionDetected) {
                showNotification('Security extension not detected. Cannot proceed.', 'error');
                return;
            }

            // Get configuration file path
            const configFile = document.getElementById('configSelection').value;
            const configUrl = window.location.origin + window.location.pathname.replace(/[^\/]*$/, '') + configFile;

            // Show fullscreen consent dialog
            const consentMessage = `
SECURE ASSESSMENT MODE CONSENT

Configuration: ${configFile.replace('.json', '').replace('config-', '').toUpperCase()}

By proceeding, you agree to the following security measures:

‚úì Switching to other applications will be detected and logged
‚úì Attempting to exit the assessment will trigger warnings
‚úì All focus violations will be recorded
‚úì Security violations may result in assessment termination
‚úì All activity will be monitored for academic integrity
‚úì Browser extensions will be managed according to selected configuration

Do you consent to these security measures and wish to begin the secure assessment?
            `;

            if (!confirm(consentMessage)) {
                showNotification('Security consent required to proceed with assessment', 'warning');
                return;
            }

            try {
                // Get student data if provided
                const studentName = document.getElementById('studentName').value.trim();
                const studentId = document.getElementById('studentId').value.trim();

                // Use extension bridge if available
                if (window.vrettaSoftLockExtension && window.vrettaSoftLockExtension.activateSoftLock) {
                    await window.vrettaSoftLockExtension.activateSoftLock(window.location.href, configUrl);
                    handleActivationSuccess();
                    return;
                }

                // Fallback to postMessage
                window.postMessage({
                    type: 'VRETTA_ACTIVATE_REQUEST',
                    url: window.location.href,
                    configUrl: configUrl,
                    studentData: { name: studentName, id: studentId }
                }, '*');

                // Set timeout for activation
                setTimeout(() => {
                    if (!securityActive) {
                        showNotification('Activation timeout. Please try again.', 'error');
                    }
                }, 5000);

            } catch (error) {
                console.error('Activation error:', error);
                showNotification('Failed to activate secure mode. Please contact support.', 'error');
            }
        }

        // Professional security mode deactivation
        async function deactivateSecurityMode() {
            if (!confirm('Are you sure you want to end the secure assessment session? This action will be logged.')) {
                return;
            }

            try {
                // Use extension bridge if available
                if (window.vrettaSoftLockExtension && window.vrettaSoftLockExtension.deactivateSoftLock) {
                    await window.vrettaSoftLockExtension.deactivateSoftLock();
                    handleDeactivationSuccess();
                    return;
                }

                // Fallback to postMessage
                window.postMessage({
                    type: 'VRETTA_DEACTIVATE_REQUEST'
                }, '*');

            } catch (error) {
                console.error('Deactivation error:', error);
                showNotification('Failed to deactivate secure mode. Please contact support.', 'error');
            }
        }

        function handleActivationSuccess() {
            securityActive = true;
            updateSecurityUI();
            showNotification('üîí Secure assessment mode activated successfully!', 'success');
            
            // Make form elements more secure
            document.body.classList.add('secured');
        }

        function handleDeactivationSuccess() {
            securityActive = false;
            updateSecurityUI();
            showNotification('üîì Secure assessment session ended', 'warning');
            
            // Remove security styling
            document.body.classList.remove('secured');
        }

        function updateSecurityUI() {
            const securityIndicator = document.getElementById('securityIndicator');
            const activateBtn = document.getElementById('activateBtn');
            const deactivateBtn = document.getElementById('deactivateBtn');
            
            if (securityActive) {
                securityIndicator.className = 'security-indicator security-active';
                securityIndicator.textContent = 'üîí Secure Mode Active';
                activateBtn.disabled = true;
                deactivateBtn.disabled = false;
            } else {
                securityIndicator.className = 'security-indicator security-inactive';
                securityIndicator.textContent = 'üîì Standard Mode';
                activateBtn.disabled = !vrettaExtensionDetected;
                deactivateBtn.disabled = true;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Listen for extension messages
            window.addEventListener('message', function(event) {
                if (event.source !== window) return;

            switch (event.data.type) {
                case 'VRETTA_EXTENSION_READY':
                    handleExtensionDetected();
                        break;
                        
                case 'VRETTA_SOFT_LOCK_ACTIVATED':
                    handleActivationSuccess();
                        break;
                        
                case 'VRETTA_SOFT_LOCK_DEACTIVATED':
                    handleDeactivationSuccess();
                        break;
                        
                case 'VRETTA_ACTIVATION_FAILED':
                    showNotification('Security activation failed. Please try again.', 'error');
                        break;
                        
                case 'VRETTA_DEACTIVATION_FAILED':
                    showNotification('Security deactivation failed. Please contact support.', 'error');
                        break;
                }
            });

        // Initial extension detection ping
                    window.postMessage({
            type: 'VRETTA_PING_REQUEST',
            timestamp: Date.now()
                    }, '*');

        // Prevent common security bypasses
        document.addEventListener('keydown', function(e) {
            if (securityActive) {
                // Block common development shortcuts during secure mode
                if ((e.ctrlKey || e.metaKey) && ['i', 'j', 'u', 'p'].includes(e.key.toLowerCase())) {
                    e.preventDefault();
                    showNotification('Development tools are disabled during secure assessment', 'warning');
                }
            }
        });
    </script>
</body>
</html> 