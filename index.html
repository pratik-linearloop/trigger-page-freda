<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vretta Soft Lock - Secure Testing Environment</title>
    
    <!-- CKEditor 5 CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 30px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .header .description {
            color: #95a5a6;
            font-size: 1em;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .extension-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-dot.active {
            background: #27ae60;
        }

        .security-controls {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-secondary {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .assessment-area {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 1.8em;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .instructions {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-left: 4px solid #667eea;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .instructions h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .instructions ul {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            color: #6c757d;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #495057;
            font-size: 1.1em;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-area {
            min-height: 150px;
            resize: vertical;
        }

        .ck-editor__editable {
            min-height: 250px !important;
        }

        .security-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 30px;
            font-weight: 700;
            font-size: 14px;
            color: white;
            z-index: 1000;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .security-inactive {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .security-active {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .notification.error {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        /* Business-ready responsive design */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .security-controls {
                justify-content: center;
            }
            
            .btn {
                padding: 15px 30px;
            }
        }

        /* Prevent Chrome Help Me Write */
        input[type="text"],
        input[type="email"],
        textarea,
        .ck-editor__editable {
            -webkit-writing-suggestions: none !important;
            writing-suggestions: none !important;
        }

        /* Additional security styling */
        ::selection {
            background: rgba(102, 126, 234, 0.2);
        }

        .secured {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Violations Log Styles */
        .violations-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .violation-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .violation-icon {
            font-size: 18px;
            margin-right: 10px;
            width: 25px;
            text-align: center;
        }

        .violation-content {
            flex: 1;
        }

        .violation-message {
            font-weight: 600;
            color: #e74c3c;
            margin-bottom: 2px;
        }

        .violation-timestamp {
            font-size: 12px;
            color: #6c757d;
        }

        .no-violations {
            text-align: center;
            color: #28a745;
            font-style: italic;
            padding: 20px;
        }

        /* Copy-Paste Button Styles */
        .editor-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
        }

        .copy-paste-btn {
            padding: 8px 16px;
            border: 1px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .copy-paste-btn:hover {
            background: #667eea;
            color: white;
        }

        .copy-paste-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Vretta Soft Lock</h1>
        </div>

        <div class="status-bar">
            <div class="extension-status">
                <div id="statusDot" class="status-dot"></div>
                <span id="extensionMessage">Checking security extension...</span>
            </div>
            <div class="security-controls">
                <button id="activateBtn" class="btn btn-primary" onclick="activateSecurityMode()" disabled>
                    🔒 Activate Secure Mode
                </button>
                <button id="deactivateBtn" class="btn btn-secondary" onclick="deactivateSecurityMode()" disabled>
                    🔓 End Secure Session
                </button>
            </div>
        </div>

        <div class="assessment-area">
            <h2 class="section-title">📝 Assessment Workspace</h2>
            
            <div class="instructions">
                <h4>🔐 Secure Assessment Instructions</h4>
                <p><strong>This is a monitored assessment environment.</strong> Once secure mode is activated:</p>
                <ul>
                    <li>Content copying, cutting, and pasting will be completely disabled</li>
                    <li>Right-click context menus will be blocked throughout the session</li>
                    <li>Text selection will be restricted to input fields only</li>
                    <li>New tabs and windows will be automatically prevented</li>
                    <li>Browser extensions will be temporarily managed for security</li>
                    <li>Chrome's "Help me write" feature will be disabled</li>
                    <li><strong>Switching to other applications will trigger security warnings</strong></li>
                    <li><strong>Focus violations will be logged and may result in assessment termination</strong></li>
                    <li>All activity will be logged for academic integrity purposes</li>
                </ul>
                <div style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); padding: 15px; border-radius: 5px; margin-top: 15px;">
                    <strong>⚠️ Important:</strong> Do not attempt to leave this browser window or switch applications during the assessment. These actions will be detected and logged as security violations.
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="studentName">👤 Student Name (Optional)</label>
                <input type="text" id="studentName" class="form-control" 
                       placeholder="Enter your full name (optional)"
                       autocomplete="off"
                       spellcheck="false">
            </div>

            <div class="form-group">
                <label class="form-label" for="studentId">🎓 Student ID (Optional)</label>
                <input type="text" id="studentId" class="form-control" 
                       placeholder="Enter your student ID (optional)"
                       autocomplete="off"
                       spellcheck="false">
            </div>

            <div class="form-group">
                <label class="form-label" for="configSelection">⚙️ Assessment Configuration</label>
                <select id="configSelection" class="form-control">
                    <option value="config-standard.json">Standard Configuration (Default)</option>
                    <option value="config-strict.json">Strict Mode (Enhanced Security)</option>
                    <option value="config-ai-allowed.json">AI-Assisted (Accessibility)</option>
                </select>
                <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                    Choose the appropriate security level for your assessment environment. Standard mode provides basic security features, Strict mode offers enhanced protection with additional monitoring, and AI-Assisted mode allows certain accessibility features while maintaining assessment integrity.
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="assessmentResponse">📝 Assessment Response</label>
                <textarea id="assessmentResponse" class="form-control text-area" 
                          placeholder="Type your assessment response here. This area will be monitored during secure mode."
                          autocomplete="off"
                          spellcheck="true"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label" for="richTextEditor">✏️ Rich Text Editor</label>
                <div class="editor-controls">
                    <button type="button" class="copy-paste-btn" onclick="copyEditorContent()">
                        📋 Copy Content
                    </button>
                    <button type="button" class="copy-paste-btn" onclick="pasteToEditor()">
                        📄 Paste Content
                    </button>
                    <button type="button" class="copy-paste-btn" onclick="clearEditor()">
                        🗑️ Clear Editor
                    </button>
                </div>
                <div id="richTextEditor"></div>
            </div>
        </div>

        <!-- Violations Log Section -->
        <div class="assessment-area">
            <h2 class="section-title">⚠️ Security Violations Log</h2>
            <div id="violationsLog" class="violations-container">
                <div class="no-violations">
                    <p>🔒 No security violations detected</p>
                </div>
            </div>
            <button id="clearLogBtn" class="btn btn-secondary" onclick="clearViolationsLog()" style="margin-top: 15px;">
                🗑️ Clear Log
            </button>
        </div>
    </div>

    <div id="securityIndicator" class="security-indicator security-inactive">
        🔓 Standard Mode
    </div>

    <div id="notification" class="notification"></div>

    <script>
        let securityActive = false;
        let vrettaExtensionDetected = false;
        let richTextEditor = null;
        let violationsData = [];

        // Violations API and Logging Functions
        function logViolation(type, message, details = {}) {
            const violation = {
                id: Date.now(),
                type: type,
                message: message,
                timestamp: new Date(),
                details: details,
                icon: getViolationIcon(type)
            };
            
            violationsData.push(violation);
            displayViolation(violation);
            
            // Send to API endpoint if available
            sendViolationToAPI(violation);
            
            console.warn('Security Violation:', violation);
        }

        function getViolationIcon(type) {
            const iconMap = {
                'focus': '👁️',
                'copy': '📋',
                'paste': '📄',
                'navigate': '🔄',
                'tab': '🔗',
                'devtools': '🔧',
                'virtual-copy': '🖱️',
                'context-menu': '📝',
                'shortcut': '⌨️',
                'window': '🪟',
                'general': '⚠️'
            };
            return iconMap[type] || '⚠️';
        }

        function displayViolation(violation) {
            const logContainer = document.getElementById('violationsLog');
            const noViolationsMsg = logContainer.querySelector('.no-violations');
            
            if (noViolationsMsg) {
                noViolationsMsg.style.display = 'none';
            }
            
            const violationElement = document.createElement('div');
            violationElement.className = 'violation-item';
            violationElement.innerHTML = `
                <div class="violation-icon">${violation.icon}</div>
                <div class="violation-content">
                    <div class="violation-message">${violation.message}</div>
                    <div class="violation-timestamp">${violation.timestamp.toLocaleString()}</div>
                </div>
            `;
            
            logContainer.appendChild(violationElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function sendViolationToAPI(violation) {
            try {
                const response = await fetch('/api/violations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...violation,
                        sessionId: getSessionId(),
                        studentId: document.getElementById('studentId').value || 'anonymous',
                        url: window.location.href
                    })
                });
                
                if (!response.ok) {
                    console.warn('Failed to send violation to API:', response.statusText);
                }
            } catch (error) {
                console.warn('API endpoint not available:', error.message);
            }
        }

        function getSessionId() {
            if (!sessionStorage.getItem('vrettaSessionId')) {
                sessionStorage.setItem('vrettaSessionId', 'vretta_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9));
            }
            return sessionStorage.getItem('vrettaSessionId');
        }

        function clearViolationsLog() {
            if (confirm('Are you sure you want to clear the violations log?')) {
                violationsData = [];
                const logContainer = document.getElementById('violationsLog');
                logContainer.innerHTML = '<div class="no-violations"><p>🔒 No security violations detected</p></div>';
            }
        }

        // Copy-Paste Functions for Rich Text Editor
        async function copyEditorContent() {
            if (!richTextEditor) {
                showNotification('Rich text editor not initialized', 'error');
                return;
            }
            
            try {
                const content = richTextEditor.getData();
                await navigator.clipboard.writeText(content);
                showNotification('Content copied to clipboard', 'success');
                logViolation('copy', 'Content copied from rich text editor', { contentLength: content.length });
            } catch (error) {
                showNotification('Failed to copy content', 'error');
                console.error('Copy error:', error);
            }
        }

        async function pasteToEditor() {
            if (!richTextEditor) {
                showNotification('Rich text editor not initialized', 'error');
                return;
            }
            
            try {
                const text = await navigator.clipboard.readText();
                richTextEditor.setData(text);
                showNotification('Content pasted to editor', 'success');
                logViolation('paste', 'Content pasted to rich text editor', { contentLength: text.length });
            } catch (error) {
                showNotification('Failed to paste content - clipboard access denied', 'error');
                console.error('Paste error:', error);
            }
        }

        function clearEditor() {
            if (!richTextEditor) {
                showNotification('Rich text editor not initialized', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to clear the editor content?')) {
                richTextEditor.setData('');
                showNotification('Editor content cleared', 'success');
            }
        }

        // Virtual Copy-Paste Prevention
        function preventVirtualCopyPaste() {
            // Prevent virtual clipboard access
            document.addEventListener('copy', function(e) {
                if (securityActive) {
                    logViolation('virtual-copy', 'Attempted virtual copy operation detected');
                    e.preventDefault();
                    showNotification('Copy operation blocked in secure mode', 'warning');
                }
            });

            document.addEventListener('cut', function(e) {
                if (securityActive) {
                    logViolation('virtual-copy', 'Attempted virtual cut operation detected');
                    e.preventDefault();
                    showNotification('Cut operation blocked in secure mode', 'warning');
                }
            });

            document.addEventListener('paste', function(e) {
                if (securityActive) {
                    // Allow paste only in designated input fields
                    const allowedElements = ['INPUT', 'TEXTAREA'];
                    const isAllowedElement = allowedElements.includes(e.target.tagName);
                    const isRichEditor = e.target.closest('.ck-editor');
                    
                    if (!isAllowedElement && !isRichEditor) {
                        logViolation('virtual-copy', 'Attempted virtual paste operation in restricted area');
                        e.preventDefault();
                        showNotification('Paste operation blocked in secure mode', 'warning');
                    }
                }
            });

            // Monitor for keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (securityActive && (e.ctrlKey || e.metaKey)) {
                    const blockedKeys = ['c', 'v', 'x', 'a'];
                    if (blockedKeys.includes(e.key.toLowerCase())) {
                        const isInputField = ['INPUT', 'TEXTAREA'].includes(e.target.tagName);
                        const isRichEditor = e.target.closest('.ck-editor');
                        
                        if (!isInputField && !isRichEditor) {
                            logViolation('shortcut', `Blocked keyboard shortcut: Ctrl+${e.key.toUpperCase()}`);
                            e.preventDefault();
                            showNotification(`Keyboard shortcut Ctrl+${e.key.toUpperCase()} blocked in secure mode`, 'warning');
                        }
                    }
                }
            });

            // Monitor focus changes (window switching detection)
            let windowFocused = true;
            window.addEventListener('focus', function() {
                if (!windowFocused && securityActive) {
                    logViolation('focus', 'User returned to assessment window');
                }
                windowFocused = true;
            });

            window.addEventListener('blur', function() {
                if (securityActive) {
                    logViolation('focus', 'User switched away from assessment window');
                    showNotification('⚠️ Focus violation detected - returning to assessment', 'warning');
                }
                windowFocused = false;
            });

            // Monitor right-click attempts
            document.addEventListener('contextmenu', function(e) {
                if (securityActive) {
                    logViolation('context-menu', 'Right-click context menu attempt blocked');
                    e.preventDefault();
                    showNotification('Context menu disabled in secure mode', 'warning');
                }
            });
        }

        // Business-ready CKEditor configuration
        function initializeCKEditor() {
            ClassicEditor
                .create(document.querySelector('#richTextEditor'), {
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'underline', '|',
                        'bulletedList', 'numberedList', '|',
                        'outdent', 'indent', '|',
                        'blockQuote', 'insertTable', '|',
                        'undo', 'redo'
                    ],
                    heading: {
                        options: [
                            { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                            { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                            { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                            { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                        ]
                    },
                    placeholder: 'Type your detailed assessment response here. Rich formatting is available for professional presentation.',
                    // Disable Chrome Help Me Write
                    extraPlugins: [],
                    removePlugins: ['SmartSuggestions', 'WritingAssistance']
                })
                .then(editor => {
                    richTextEditor = editor;
                    
                    // Disable writing suggestions on the editor
                    const editable = editor.editing.view.document.getRoot();
                    editor.editing.view.change(writer => {
                        writer.setAttribute('writing-suggestions', 'false', editable);
                        writer.setAttribute('data-writing-suggestions', 'false', editable);
                    });
                    
                    console.log('Professional CKEditor initialized successfully');
                })
                .catch(error => {
                    console.error('Error initializing CKEditor:', error);
                    showNotification('Rich text editor failed to load', 'error');
                });
        }

        // Disable Chrome Help Me Write feature
        function disableChromeHelpMeWrite() {
            // Apply to all existing inputs
            const inputs = document.querySelectorAll('input[type="text"], input[type="email"], textarea');
            inputs.forEach(input => {
                input.setAttribute('writing-suggestions', 'false');
                input.setAttribute('data-writing-suggestions', 'false');
                input.style.writingSuggestions = 'none';
            });

            // Disable for future elements
            const observer = new MutationObserver(mutations => {
                mutations.forEach(mutation => {
                    mutation.addedNodes.forEach(node => {
                        if (node.nodeType === 1) { // Element node
                            const newInputs = node.querySelectorAll('input[type="text"], input[type="email"], textarea');
                            newInputs.forEach(input => {
                                input.setAttribute('writing-suggestions', 'false');
                                input.setAttribute('data-writing-suggestions', 'false');
                                input.style.writingSuggestions = 'none';
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Initialize everything when page loads
        window.addEventListener('load', function() {
            detectExtension();
            initializeCKEditor();
            disableChromeHelpMeWrite();
            preventVirtualCopyPaste();
            
            // Set up professional form validation
            setupFormValidation();
        });

        // Professional form validation
        function setupFormValidation() {
            const studentName = document.getElementById('studentName');
            const studentId = document.getElementById('studentId');

            studentName.addEventListener('blur', function() {
                if (this.value.trim().length < 2) {
                    this.style.borderColor = '#e74c3c';
                } else {
                    this.style.borderColor = '#27ae60';
                }
            });

            studentId.addEventListener('blur', function() {
                if (this.value.trim().length < 3) {
                    this.style.borderColor = '#e74c3c';
                } else {
                    this.style.borderColor = '#27ae60';
                }
            });
        }

        // Extension detection
        function detectExtension() {
            // Check for extension bridge
            if (window.vrettaSoftLockExtension && window.vrettaSoftLockExtension.isAvailable) {
                handleExtensionDetected();
                return;
            }

            // Ping extension
            window.postMessage({ type: 'VRETTA_PING_REQUEST' }, '*');
            
            setTimeout(() => {
                if (!vrettaExtensionDetected) {
                    handleExtensionNotDetected();
                }
            }, 2000);
        }

        function handleExtensionDetected() {
            vrettaExtensionDetected = true;
            const statusDot = document.getElementById('statusDot');
            const messageSpan = document.getElementById('extensionMessage');
            
            statusDot.classList.add('active');
            messageSpan.textContent = '✅ Vretta Security Extension Ready';
            
            document.getElementById('activateBtn').disabled = false;
            showNotification('Security extension detected and ready for use', 'success');
        }

        function handleExtensionNotDetected() {
            const messageSpan = document.getElementById('extensionMessage');
            messageSpan.innerHTML = '❌ Security extension required - <a href="#" onclick="location.reload()">Refresh Page</a>';
            
            document.getElementById('activateBtn').disabled = true;
            showNotification('Please install the Vretta Security Extension to continue', 'error');
        }

        // Security mode activation
        async function activateSecurityMode() {
            if (!vrettaExtensionDetected) {
                showNotification('Security extension not detected. Cannot proceed.', 'error');
                return;
            }

            // Get configuration file path
            const configFile = document.getElementById('configSelection').value;
            const configUrl = window.location.origin + window.location.pathname.replace(/[^\/]*$/, '') + configFile;

            // Show fullscreen consent dialog
            const consentMessage = `
SECURE ASSESSMENT MODE CONSENT

Configuration: ${configFile.replace('.json', '').replace('config-', '').toUpperCase()}

By proceeding, you agree to the following security measures:

✓ Switching to other applications will be detected and logged
✓ Attempting to exit the assessment will trigger warnings
✓ All focus violations will be recorded
✓ Security violations may result in assessment termination
✓ All activity will be monitored for academic integrity
✓ Browser extensions will be managed according to selected configuration

Do you consent to these security measures and wish to begin the secure assessment?
            `;

            if (!confirm(consentMessage)) {
                showNotification('Security consent required to proceed with assessment', 'warning');
                return;
            }

            try {
                // Use extension bridge if available
                if (window.vrettaSoftLockExtension && window.vrettaSoftLockExtension.activateSoftLock) {
                    await window.vrettaSoftLockExtension.activateSoftLock(window.location.href, configUrl);
                    handleActivationSuccess();
                    return;
                }

                // Fallback to postMessage
                window.postMessage({
                    type: 'VRETTA_ACTIVATE_REQUEST',
                    url: window.location.href,
                    configUrl: configUrl
                }, '*');

                // Set timeout for activation
                setTimeout(() => {
                    if (!securityActive) {
                        showNotification('Activation timeout. Please try again.', 'error');
                    }
                }, 5000);

            } catch (error) {
                console.error('Activation error:', error);
                showNotification('Failed to activate secure mode. Please contact support.', 'error');
            }
        }

        // Security mode deactivation
        async function deactivateSecurityMode() {
            if (!confirm('Are you sure you want to end the secure assessment session? This action will be logged.')) {
                return;
            }

            try {
                // Use extension bridge if available
                if (window.vrettaSoftLockExtension && window.vrettaSoftLockExtension.deactivateSoftLock) {
                    await window.vrettaSoftLockExtension.deactivateSoftLock();
                    handleDeactivationSuccess();
                    return;
                }

                // Fallback to postMessage
                window.postMessage({
                    type: 'VRETTA_DEACTIVATE_REQUEST'
                }, '*');

            } catch (error) {
                console.error('Deactivation error:', error);
                showNotification('Failed to deactivate secure mode. Please contact support.', 'error');
            }
        }

        function handleActivationSuccess() {
            securityActive = true;
            updateSecurityUI();
            showNotification('🔒 Secure assessment mode activated successfully!', 'success');
            
            // Make form elements more secure
            document.body.classList.add('secured');
        }

        function handleDeactivationSuccess() {
            securityActive = false;
            updateSecurityUI();
            showNotification('🔓 Secure assessment session ended', 'warning');
            
            // Remove security styling
            document.body.classList.remove('secured');
        }

        function updateSecurityUI() {
            const securityIndicator = document.getElementById('securityIndicator');
            const activateBtn = document.getElementById('activateBtn');
            const deactivateBtn = document.getElementById('deactivateBtn');
            
            if (securityActive) {
                securityIndicator.className = 'security-indicator security-active';
                securityIndicator.textContent = '🔒 Secure Mode Active';
                activateBtn.disabled = true;
                deactivateBtn.disabled = false;
            } else {
                securityIndicator.className = 'security-indicator security-inactive';
                securityIndicator.textContent = '🔓 Standard Mode';
                activateBtn.disabled = !vrettaExtensionDetected;
                deactivateBtn.disabled = true;
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // Listen for extension messages
        window.addEventListener('message', function(event) {
            if (event.source !== window) return;

            switch (event.data.type) {
                case 'VRETTA_EXTENSION_READY':
                    handleExtensionDetected();
                    break;
                    
                case 'VRETTA_SOFT_LOCK_ACTIVATED':
                    handleActivationSuccess();
                    break;
                    
                case 'VRETTA_SOFT_LOCK_DEACTIVATED':
                    handleDeactivationSuccess();
                    break;
                    
                case 'VRETTA_ACTIVATION_FAILED':
                    showNotification('Security activation failed. Please try again.', 'error');
                    break;
                    
                case 'VRETTA_DEACTIVATION_FAILED':
                    showNotification('Security deactivation failed. Please contact support.', 'error');
                    break;
            }
        });

        // Initial extension detection ping
        window.postMessage({
            type: 'VRETTA_PING_REQUEST',
            timestamp: Date.now()
        }, '*');

        // Prevent common security bypasses
        document.addEventListener('keydown', function(e) {
            if (securityActive) {
                // Block common development shortcuts during secure mode
                if ((e.ctrlKey || e.metaKey) && ['i', 'j', 'u', 'p'].includes(e.key.toLowerCase())) {
                    e.preventDefault();
                    showNotification('Development tools are disabled during secure assessment', 'warning');
                }
            }
        });
    </script>
</body>
</html> 